package hu.advancedweb;

import org.openjdk.jmh.annotations.Benchmark;
import org.openjdk.jmh.annotations.Scope;
import org.openjdk.jmh.annotations.State;

/**
 * This test shows, that too large methods will not be inlined,
 * even if they are on a hot path.
 * 
 * The doSomeCalculation method in its current form will be inlined in this test.
 * However, if you move the 'assert false' statements directly to the if part of the branch,
 * it will be too large for inlining.
 * 
 * The size limit takes assertion statements into account, even if they are disabled. (Which is the case by default.)
 * 
 * Run this test with:
 * mvn clean install; java -jar target/benchmarks.jar "hu.advancedweb.InliningBasedOnCalleeSize.*"
 * 
 * To enable diagnostic log about inlining:
 * mvn clean install; java -jar -XX:+PrintCompilation -XX:+UnlockDiagnosticVMOptions -XX:+PrintInlining target/benchmarks.jar "hu.advancedweb.InliningBasedOnCalleeSize.*"
 * 
 * @author David Csakvari
 */
public class InliningBasedOnCalleeSize {
	
	@State(Scope.Thread)
    public static class MyState {
        public int valueSink; // just store the result somewhere, to avoid dead code removal
    }
	
    @Benchmark
    public void testMethod(MyState s) throws Exception {
    	s.valueSink = s.valueSink + doSomeCalculation(1,1);
    }
    
    int handleUserInteraction(int startValue) throws Exception {
		int value = 5;
		
		for (int step = startValue; step < 50000; step ++) {
			value = doSomeCalculation(value, step);
		}
		
		return value;
	}
	
	int doSomeCalculation(int startValue, int step) throws Exception {
		if (step == 0) {
			return handleEdgeCase();
		} else {
			return startValue + step;
		}
	}

	private int handleEdgeCase() {
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		assert false;
		return 1;
	}

}
